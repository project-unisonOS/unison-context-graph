name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  tests-matrix:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service: [
          unison-common,
          unison-auth,
          unison-context,
          unison-inference,
          unison-storage,
          unison-io-speech,
          unison-io-vision,
          unison-context-graph
        ]
    env:
      OTEL_TRACES_EXPORTER: none
      OTEL_METRICS_EXPORTER: none
      OTEL_LOGS_EXPORTER: none
      OTEL_EXPORTER_OTLP_ENDPOINT: ""
      PYTHONWARNINGS: default
      UNISON_REQUIRE_CONSENT: "false"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install base deps
        run: |
          python -m pip install --upgrade pip wheel
      - name: Install project deps
        run: |
          python -m pip install -e unison-common
          if [ "${{ matrix.service }}" != "unison-common" ]; then \
            python -m pip install -r ${{ matrix.service }}/requirements.txt; \
          fi
          python -m pip install pytest-cov pytest-rerunfailures
      - name: Run tests (${{ matrix.service }})
        run: |
          if [ "${{ matrix.service }}" = "unison-common" ]; then \
            (cd unison-common && pytest -q --maxfail=1 --durations=15 --reruns 1 --cov=unison_common --cov-report=term-missing --cov-fail-under=80); \
          else \
            (cd ${{ matrix.service }} && pytest -q --maxfail=1 --durations=15 --reruns 1); \
          fi

  unison-policy-tests:
    runs-on: ubuntu-latest
    needs: tests-matrix
    services:
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping || exit 1" \
          --health-interval 5s \
          --health-timeout 3s \
          --health-retries 20
    env:
      OTEL_TRACES_EXPORTER: none
      OTEL_METRICS_EXPORTER: none
      OTEL_LOGS_EXPORTER: none
      OTEL_EXPORTER_OTLP_ENDPOINT: ""
      REDIS_HOST: 127.0.0.1
      REDIS_PORT: 6379
      UNISON_CONSENT_SECRET: test-secret
      UNISON_CONSENT_AUDIENCE: unison
      UNISON_CONSENT_DEFAULT_TTL_HOURS: 1
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip wheel
          python -m pip install "git+https://github.com/project-unisonOS/unison-common.git@main"
          python -m pip install -r unison-policy/requirements.txt
          python -m pip install pytest-cov pytest-rerunfailures
      - name: Normalize requirements to use VCS unison-common
        run: |
          sed -i 's#\.{2}/unison-common/dist/unison_common-0\.1\.0-py3-none-any\.whl#git+https://github.com/project-unisonOS/unison-common.git@main#g' */requirements.txt || true
      - name: Run tests (unison-policy)
        working-directory: unison-policy
        run: pytest -q --maxfail=1 --durations=15 --reruns 1

  tests-matrix-consent:
    runs-on: ubuntu-latest
    needs: tests-matrix
    strategy:
      fail-fast: false
      matrix:
        service: [
          unison-orchestrator,
          unison-context,
          unison-inference
        ]
    env:
      OTEL_TRACES_EXPORTER: none
      OTEL_METRICS_EXPORTER: none
      OTEL_LOGS_EXPORTER: none
      OTEL_EXPORTER_OTLP_ENDPOINT: ""
      PYTHONWARNINGS: default
      UNISON_REQUIRE_CONSENT: "true"
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
      - name: Install base deps
        run: |
          python -m pip install --upgrade pip wheel
      - name: Normalize requirements to use VCS unison-common
        run: |
          sed -i 's#\.{2}/unison-common/dist/unison_common-0\.1\.0-py3-none-any\.whl#git+https://github.com/project-unisonOS/unison-common.git@main#g' */requirements.txt || true
      - name: Install project deps
        run: |
          python -m pip install "git+https://github.com/project-unisonOS/unison-common.git@main"
          python -m pip install -r ${{ matrix.service }}/requirements.txt
          python -m pip install pytest-rerunfailures
      - name: Run tests with consent enabled (${{ matrix.service }})
        run: |
          (cd ${{ matrix.service }} && pytest -q --maxfail=1 --durations=15 --reruns 1)
