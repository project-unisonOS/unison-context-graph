# P2.4: Storage Durability + Privacy Implementation Plan

## Overview

Implement storage durability and privacy features for the context-graph service to ensure data reliability and compliance with privacy requirements.

## Goals

1. **Durability**: Ensure data survives crashes and system failures
2. **Privacy**: Automatically remove PII after retention period
3. **Performance**: Maintain low latency for context operations
4. **Compliance**: Meet data retention and privacy requirements

## Architecture

### Current State

- SQLite database for replay storage (`data/context_replay.db`)
- In-memory context state
- No crash recovery mechanism
- No automatic data cleanup
- No PII scrubbing

### Target State

- Write-Ahead Log (WAL) for durability
- TTL-based automatic cleanup
- PII scrubbing for privacy
- Crash recovery on startup
- Checksums for data integrity

## Phases

### Phase 1: Write-Ahead Log (WAL)

**Goal**: Enable SQLite WAL mode for better durability and concurrency

**Tasks**:
1. Enable WAL mode on database initialization
2. Configure WAL checkpoint intervals
3. Add WAL file monitoring
4. Implement WAL cleanup on shutdown

**Benefits**:
- Better crash recovery
- Improved concurrent read/write performance
- Atomic commits

**Implementation**:
```python
# Enable WAL mode
conn.execute("PRAGMA journal_mode=WAL")
conn.execute("PRAGMA synchronous=NORMAL")
conn.execute("PRAGMA wal_autocheckpoint=1000")
```

### Phase 2: TTL Implementation

**Goal**: Automatically delete old data based on retention policy

**Tasks**:
1. Add `expires_at` column to tables
2. Implement TTL calculation on insert
3. Create background cleanup job
4. Add TTL configuration (default: 30 days)
5. Add metrics for deleted records

**Retention Policies**:
- Context snapshots: 7 days
- Event traces: 30 days
- Replay data: 90 days (configurable)
- Audit logs: 1 year

**Implementation**:
```python
# Add TTL column
ALTER TABLE events ADD COLUMN expires_at TIMESTAMP;

# Cleanup job
DELETE FROM events WHERE expires_at < datetime('now');
```

### Phase 3: PII Scrubbing

**Goal**: Remove or anonymize PII from old records

**Tasks**:
1. Identify PII fields in data model
2. Implement scrubbing functions
3. Create background scrubbing job
4. Add scrubbing metrics
5. Support configurable scrubbing rules

**PII Fields to Scrub**:
- `person_id` → hash or anonymize
- Location data → generalize (city level)
- Device identifiers → remove
- Custom user data → remove

**Scrubbing Strategies**:
- **Hash**: One-way hash for person_id
- **Generalize**: Reduce precision (GPS → city)
- **Remove**: Delete field entirely
- **Anonymize**: Replace with placeholder

**Implementation**:
```python
# Scrub PII after retention period
UPDATE events 
SET person_id = 'SCRUBBED_' || substr(person_id, 1, 8),
    location = NULL,
    device_id = NULL
WHERE created_at < datetime('now', '-90 days');
```

### Phase 4: Crash Recovery

**Goal**: Recover from crashes without data loss

**Tasks**:
1. Implement recovery on startup
2. Replay WAL if present
3. Verify checksums
4. Rebuild indexes if needed
5. Log recovery metrics

**Recovery Process**:
1. Check for WAL file on startup
2. If present, replay transactions
3. Verify database integrity
4. Checkpoint WAL
5. Resume normal operation

**Implementation**:
```python
def recover_from_crash():
    # Check for WAL file
    if os.path.exists(f"{db_path}-wal"):
        logger.info("WAL file found, recovering...")
        # SQLite automatically replays WAL
        conn = sqlite3.connect(db_path)
        # Verify integrity
        conn.execute("PRAGMA integrity_check")
        # Checkpoint
        conn.execute("PRAGMA wal_checkpoint(FULL)")
```

### Phase 5: Testing

**Goal**: Comprehensive test coverage for durability features

**Test Categories**:
1. **WAL Tests** (5 tests)
   - WAL mode enabled
   - Concurrent reads/writes
   - Checkpoint behavior
   - WAL file cleanup

2. **TTL Tests** (5 tests)
   - TTL calculation
   - Cleanup job execution
   - Expired record deletion
   - Metrics tracking

3. **PII Scrubbing Tests** (5 tests)
   - Scrubbing functions
   - Background job
   - Field-level scrubbing
   - Metrics tracking

4. **Crash Recovery Tests** (5 tests)
   - Recovery on startup
   - WAL replay
   - Integrity verification
   - Partial transaction recovery

**Total**: 20+ tests

### Phase 6: Documentation

**Goal**: Document durability and privacy features

**Documents**:
1. **DURABILITY.md** - WAL, recovery, checksums
2. **PRIVACY.md** - TTL, PII scrubbing, compliance
3. **OPERATIONS.md** - Monitoring, maintenance, troubleshooting

## Technical Details

### Database Schema Changes

```sql
-- Add TTL and scrubbing columns
ALTER TABLE events ADD COLUMN expires_at TIMESTAMP;
ALTER TABLE events ADD COLUMN scrubbed_at TIMESTAMP;
ALTER TABLE events ADD COLUMN checksum TEXT;

-- Add indexes for cleanup
CREATE INDEX idx_events_expires_at ON events(expires_at);
CREATE INDEX idx_events_scrubbed_at ON events(scrubbed_at);
```

### Configuration

```python
class DurabilityConfig:
    # WAL settings
    WAL_ENABLED = True
    WAL_CHECKPOINT_INTERVAL = 1000  # transactions
    WAL_SYNC_MODE = "NORMAL"  # FULL, NORMAL, OFF
    
    # TTL settings
    TTL_ENABLED = True
    TTL_DEFAULT_DAYS = 30
    TTL_CLEANUP_INTERVAL = 3600  # seconds (1 hour)
    
    # PII scrubbing
    PII_SCRUBBING_ENABLED = True
    PII_SCRUBBING_AFTER_DAYS = 90
    PII_SCRUBBING_INTERVAL = 86400  # seconds (1 day)
    
    # Recovery
    RECOVERY_ENABLED = True
    RECOVERY_VERIFY_CHECKSUMS = True
```

### Metrics

```prometheus
# WAL metrics
unison_context_wal_size_bytes
unison_context_wal_checkpoints_total
unison_context_wal_checkpoint_duration_seconds

# TTL metrics
unison_context_ttl_records_deleted_total
unison_context_ttl_cleanup_duration_seconds
unison_context_ttl_records_expired

# PII scrubbing metrics
unison_context_pii_records_scrubbed_total
unison_context_pii_scrubbing_duration_seconds
unison_context_pii_fields_scrubbed_total

# Recovery metrics
unison_context_recovery_attempts_total
unison_context_recovery_duration_seconds
unison_context_recovery_transactions_replayed
```

## Acceptance Criteria

### WAL
- [x] WAL mode enabled on database
- [x] Checkpoint interval configured
- [x] WAL file monitored
- [x] Cleanup on shutdown

### TTL
- [x] TTL column added
- [x] Cleanup job running
- [x] Records deleted within SLA (24h)
- [x] Metrics exposed

### PII Scrubbing
- [x] PII fields identified
- [x] Scrubbing functions implemented
- [x] Background job running
- [x] Metrics exposed

### Crash Recovery
- [x] Recovery on startup
- [x] WAL replay working
- [x] Checksums verified
- [x] Metrics exposed

### Testing
- [x] 20+ tests written
- [x] All tests passing
- [x] Coverage > 80%

### Documentation
- [x] DURABILITY.md complete
- [x] PRIVACY.md complete
- [x] OPERATIONS.md complete

## Implementation Order

1. **Phase 1**: WAL (1 day)
   - Enable WAL mode
   - Configure checkpoints
   - Add monitoring

2. **Phase 2**: TTL (1 day)
   - Add TTL columns
   - Implement cleanup job
   - Add metrics

3. **Phase 3**: PII Scrubbing (1 day)
   - Implement scrubbing functions
   - Create background job
   - Add metrics

4. **Phase 4**: Crash Recovery (1 day)
   - Implement recovery logic
   - Add integrity checks
   - Add metrics

5. **Phase 5**: Testing (1 day)
   - Write 20+ tests
   - Verify all features
   - Fix issues

6. **Phase 6**: Documentation (0.5 days)
   - Write documentation
   - Add examples
   - Update README

**Total Estimated Time**: 5.5 days

## Risks and Mitigations

### Risk 1: WAL Performance Impact

**Risk**: WAL mode may impact write performance

**Mitigation**:
- Use NORMAL sync mode (not FULL)
- Configure appropriate checkpoint interval
- Monitor performance metrics

### Risk 2: TTL Cleanup Blocking

**Risk**: Cleanup job may block other operations

**Mitigation**:
- Run cleanup during low-traffic periods
- Use batched deletes (1000 records at a time)
- Add timeout to cleanup job

### Risk 3: PII Scrubbing Errors

**Risk**: Scrubbing may fail or corrupt data

**Mitigation**:
- Test scrubbing functions thoroughly
- Use transactions for scrubbing
- Add rollback capability
- Log all scrubbing operations

### Risk 4: Recovery Failures

**Risk**: Recovery may fail on corrupted WAL

**Mitigation**:
- Verify checksums before recovery
- Have fallback to last good backup
- Log recovery attempts
- Alert on recovery failures

## Success Metrics

- **Durability**: 99.9% data survival rate
- **TTL**: Records deleted within 24h of expiration
- **PII**: 100% of old records scrubbed
- **Recovery**: < 10s recovery time
- **Performance**: < 5% overhead from durability features

## Next Steps

After P2.4 completion:
1. Monitor durability metrics in production
2. Tune WAL checkpoint interval
3. Adjust TTL policies based on usage
4. Review PII scrubbing effectiveness
5. Move to P3 (DX and Ops Polish)
